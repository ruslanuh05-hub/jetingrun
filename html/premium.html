<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Telegram Premium — JET</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
            min-height: 100vh;
            background: linear-gradient(180deg, #0d0a14 0%, #1a1525 25%, #251d35 50%, #1e1830 75%, #16122a 100%);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .supercell-popup-content {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            width: 100%;
        }
        .steam-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px max(16px, env(safe-area-inset-left)) 14px max(16px, env(safe-area-inset-right));
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            flex-shrink: 0;
        }
        .steam-back-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .steam-popup-title {
            color: #ffffff;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }
        .steam-popup-body {
            flex: 1;
            padding: 20px max(16px, env(safe-area-inset-left)) max(100px, calc(80px + env(safe-area-inset-bottom, 0))) max(16px, env(safe-area-inset-right));
            overflow-y: auto;
            overflow-x: hidden;
        }
        .store-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 100%;
        }
        .store-field { display: flex; flex-direction: column; gap: 8px; }
        .store-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            font-weight: 500;
        }
        .store-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .store-input-wrapper {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            background: rgba(22, 27, 51, 0.95);
            border-radius: 14px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            padding: 0 14px;
        }
        .store-input-icon { color: rgba(255, 255, 255, 0.5); margin-right: 10px; }
        .store-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            padding: 12px 0;
            color: #ffffff;
            font-size: 0.95rem;
            min-width: 0;
        }
        .store-input::placeholder { color: rgba(255, 255, 255, 0.35); }
        .store-input-action {
            border: none;
            background: none;
            color: #4e8cff;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .store-field-hint {
            color: rgba(255, 255, 255, 0.45);
            font-size: 0.8rem;
        }
        .premium-card-compact {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(10, 10, 10, 0.9) 100%);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .premium-card-compact:hover {
            border-color: rgba(0, 212, 255, 0.5);
            transform: translateX(2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        .premium-card-compact.selected {
            border-color: #00d4ff;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(64, 224, 208, 0.1) 100%);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
            transform: translateX(3px) scale(1.01);
        }
        .premium-card-left { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        .premium-card-duration { color: #fff; font-size: 0.85rem; font-weight: 700; }
        .premium-card-prices { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; min-width: 0; text-align: right; }
        .premium-price-usd { color: #fff; font-size: 0.9rem; font-weight: 700; }
        .premium-price-rub { color: rgba(255,255,255,0.6); font-size: 0.75rem; }
        .premium-card-radio {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
        }
        .premium-card-compact.selected .premium-card-radio {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.15);
        }
        .premium-card-compact.selected .premium-card-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #00d4ff;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.9);
        }
        .premium-card-badge-compact {
            position: absolute;
            top: -3px;
            right: 8px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            font-size: 0.55rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 6px;
            z-index: 10;
            text-transform: uppercase;
        }
        .premium-card-badge-above-compact {
            display: block;
            color: #4CAF50;
            font-size: 0.55rem;
            font-weight: 700;
            margin-bottom: 1px;
            text-transform: uppercase;
        }
        .continue-btn {
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, #00d4ff 0%, #40e0d0 100%);
            border: none;
            border-radius: 14px;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
            box-shadow: 0 4px 18px rgba(0, 212, 255, 0.4);
            flex-shrink: 0;
        }
        .continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }
        .continue-btn.disabled {
            opacity: 0.6;
            cursor: default;
        }
        .continue-btn.disabled:hover { transform: none; }
        @media (max-width: 400px) {
            .steam-popup-body {
                padding-left: 12px;
                padding-right: 12px;
                padding-bottom: max(120px, calc(100px + env(safe-area-inset-bottom, 0)));
            }
            .premium-card-compact {
                grid-template-columns: 1fr minmax(0, auto) minmax(0, auto);
            }
        }
    </style>
    <link rel="stylesheet" href="../css/mobile.css?v=3">
</head>
<body>
    <div class="supercell-popup-content">
        <header class="steam-popup-header">
            <a href="index.html" class="steam-back-btn" id="backBtn" aria-label="Назад">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="steam-popup-title">Telegram Premium</h1>
            <div style="width: 40px;"></div>
        </header>
        <div class="steam-popup-body">
            <div class="store-form">
                <div class="store-field">
                    <label class="store-label">Получатель</label>
                    <div class="store-input-row">
                        <div class="store-input-wrapper" id="premiumRecipientWrapper">
                            <i class="fas fa-user store-input-icon"></i>
                            <input type="text" id="premiumRecipient" class="store-input" placeholder="@username получателя" autocomplete="off" onkeydown="if(event.key==='Enter'){event.preventDefault();lookupPremiumRecipientPage();}">
                            <div id="premiumUserPreview" class="tg-user-chip" style="display:none;align-items:center;gap:8px;flex:1;min-width:0;">
                                <img id="premiumUserAvatar" src="" alt="" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
                                <span id="premiumUserName" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                                <button type="button" onclick="clearPremiumRecipientPage()" style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;padding:4px;"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <span id="premiumUserError" class="store-field-error" style="display:none;color:#ff4757;font-size:0.8rem;">Пользователь не найден</span>
                        <button type="button" class="store-input-action" onclick="fillOwnUsername()">/купить себе</button>
                    </div>
                    <p class="store-field-hint">Если указан неверный @username — ответственность несёт покупатель.</p>
                </div>
                <div class="store-field">
                    <span class="store-label">Продолжительность</span>
                </div>
                <div class="premium-card-compact" data-months="3" onclick="selectPremium(3)">
                    <div class="premium-card-left">
                        <div class="premium-card-duration">3 мес.</div>
                    </div>
                    <div class="premium-card-prices">
                        <span class="premium-price-usd">0.00 $</span>
                        <span class="premium-price-rub">0 ₽</span>
                    </div>
                    <div class="premium-card-radio"></div>
                </div>
                <div class="premium-card-compact" data-months="6" onclick="selectPremium(6)">
                    <div class="premium-card-left">
                        <div class="premium-card-duration">6 мес.</div>
                    </div>
                    <div class="premium-card-prices">
                        <span class="premium-price-usd">0.00 $</span>
                        <span class="premium-price-rub">0 ₽</span>
                    </div>
                    <div class="premium-card-radio"></div>
                </div>
                <div class="premium-card-compact" data-months="12" onclick="selectPremium(12)">
                    <div class="premium-card-left">
                        <span class="premium-card-badge-above-compact">Выгодно</span>
                        <div class="premium-card-duration">12 мес.</div>
                    </div>
                    <div class="premium-card-prices">
                        <span class="premium-price-usd">0.00 $</span>
                        <span class="premium-price-rub">0 ₽</span>
                    </div>
                    <div class="premium-card-radio"></div>
                </div>
                <button class="continue-btn disabled" id="payBtn" onclick="proceedPay()">Выберите период</button>
            </div>
        </div>
    </div>
    <script>
        (function() {
            function getPremiumPrices() {
                try {
                    var prices = JSON.parse(localStorage.getItem('jetstore_premium_prices') || '{}');
                    return {
                        3: prices[3] || 983,
                        6: prices[6] || 1311,
                        12: prices[12] || 2377
                    };
                } catch (e) {
                    return { 3: 983, 6: 1311, 12: 2377 };
                }
            }
            function getUsdRate() {
                try {
                    var r = localStorage.getItem('jetstore_usd_rate');
                    if (r && parseFloat(r) > 0) return parseFloat(r);
                    return 100;  // fallback для отображения цены в $
                } catch (e) { return 100; }
            }
            function updatePricesDisplay() {
                var premiumPrices = getPremiumPrices();
                var usdRate = getUsdRate();
                document.querySelectorAll('.premium-card-compact').forEach(function(card) {
                    var months = parseInt(card.getAttribute('data-months'), 10);
                    if (!months || !premiumPrices[months]) return;
                    var price = premiumPrices[months];
                    var rubEl = card.querySelector('.premium-price-rub');
                    var usdEl = card.querySelector('.premium-price-usd');
                    if (rubEl) rubEl.textContent = price.toLocaleString('ru-RU') + ' ₽';
                    if (usdEl) usdEl.textContent = (price / usdRate).toFixed(2) + ' $';
                });
            }
            var selectedPremium = { months: 0, price: 0 };
            function updatePayButton() {
                var btn = document.getElementById('payBtn');
                if (!btn) return;
                if (selectedPremium.months > 0) {
                    var usdRate = getUsdRate();
                    var priceUsd = (selectedPremium.price / usdRate).toFixed(2);
                    btn.textContent = 'Оплатить Premium ' + selectedPremium.months + ' мес. за ' + priceUsd + ' $';
                    btn.classList.remove('disabled');
                } else {
                    btn.textContent = 'Выберите период';
                    btn.classList.add('disabled');
                }
            }
            window.selectPremium = function(months) {
                var premiumPrices = getPremiumPrices();
                var price = premiumPrices[months] || 0;
                selectedPremium = { months: months, price: price };
                document.querySelectorAll('.premium-card-compact').forEach(function(c) { c.classList.remove('selected'); });
                var target = document.querySelector('.premium-card-compact[data-months="' + months + '"]');
                if (target) target.classList.add('selected');
                updatePayButton();
            };
            window.fillOwnUsername = function() {
                var input = document.getElementById('premiumRecipient');
                if (!input) return;
                var user = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) || null;
                var username = (window.userData && window.userData.username) || (user && user.username) || '';
                var firstName = (window.userData && window.userData.firstName) || (user && user.first_name) || '';
                if (username) {
                    if (!username.startsWith('@')) username = '@' + username;
                    input.value = username;
                } else if (firstName) {
                    input.value = firstName;
                } else {
                    input.value = '';
                }
                setPremiumRecipientStatePage('empty');
            };
            function setPremiumRecipientStatePage(state, userData) {
                var w = document.getElementById('premiumRecipientWrapper');
                var inp = document.getElementById('premiumRecipient');
                var chip = document.getElementById('premiumUserPreview');
                var err = document.getElementById('premiumUserError');
                var av = document.getElementById('premiumUserAvatar');
                var nm = document.getElementById('premiumUserName');
                if (!w || !inp || !chip || !err) return;
                w.classList.remove('tg-user-input-error');
                chip.style.display = 'none';
                err.style.display = 'none';
                inp.style.display = 'block';
                if (state === 'empty') return;
                if (state === 'loading') {
                    if (av) av.src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent((userData && userData.username) || '') + '&background=00d4ff&color=fff&size=128';
                    if (nm) nm.textContent = 'Поиск...';
                    chip.style.display = 'flex';
                    inp.style.display = 'none';
                    return;
                }
                if (state === 'found' && userData) {
                    if (av) av.src = (userData.avatar) || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.username || userData.firstName || '') + '&background=00d4ff&color=fff&size=128');
                    if (nm) nm.textContent = (userData.firstName || '').trim() ? ((userData.firstName || '').trim() + ' ' + (userData.username ? '@' + userData.username : '')).trim() : (userData.username ? '@' + userData.username : '');
                    chip.style.display = 'flex';
                    inp.style.display = 'none';
                    return;
                }
                if (state === 'not_found') { w.classList.add('tg-user-input-error'); err.style.display = 'block'; }
            }
            window.clearPremiumRecipientPage = function() {
                var inp = document.getElementById('premiumRecipient');
                if (inp) inp.value = '';
                setPremiumRecipientStatePage('empty');
            };
            window.lookupPremiumRecipientPage = function() {
                var inp = document.getElementById('premiumRecipient');
                if (!inp) return;
                var username = (inp.value || '').trim().replace(/^@/, '');
                if (!username) { setPremiumRecipientStatePage('empty'); return; }
                setPremiumRecipientStatePage('loading', { username: username });
                var apiBase = window.JET_API_BASE || localStorage.getItem('jet_api_base') || window.location.origin || '';
                var url = apiBase ? (apiBase.replace(/\/$/, '') + '/api/telegram/user?username=' + encodeURIComponent(username)) : '';
                if (!url) { setPremiumRecipientStatePage('found', { username: username, firstName: username }); return; }
                fetch(url).then(function(r) { return r.json().catch(function() { return null; }); })
                    .then(function(d) {
                        if (d && (d.username || d.firstName)) setPremiumRecipientStatePage('found', d);
                        else setPremiumRecipientStatePage('not_found');
                    }).catch(function() { setPremiumRecipientStatePage('not_found'); });
            };
            window.proceedPay = function() {
                if (selectedPremium.months <= 0) return;
                var recipient = (document.getElementById('premiumRecipient') && document.getElementById('premiumRecipient').value) ? document.getElementById('premiumRecipient').value.trim() : '';
                sessionStorage.setItem('premium_pay_months', String(selectedPremium.months));
                sessionStorage.setItem('premium_pay_recipient', recipient || '');
                sessionStorage.setItem('premium_pay_amount', String(selectedPremium.price));
                window.location.href = 'index.html?pay=premium';
            };
            document.getElementById('backBtn').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'index.html';
            });
            updatePricesDisplay();
            updatePayButton();
        })();
    </script>
</body>
</html>
